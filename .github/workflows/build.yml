name: Tcl/Tk Linux-Only Distribution

on:
  workflow_dispatch:
    inputs:
      tcl-versions:
        required: true
        type: choice
        options:
          - '["9.0.3"]'
        default: '["9.0.3"]'
      architectures:
        required: true
        type: choice
        options:
          - '["x64"]'
          - '["arm64"]'
          - '["x64", "arm64"]'
        default: '["x64"]'
      config:
        type: choice
        required: true
        options:
          - 'Tcl_BI'
        default: 'Tcl_BI'

jobs:
  # -----------------------------------------------------------------------
  # Job 1: Intel x64
  # -----------------------------------------------------------------------
  build-linux:
    if: contains(github.event.inputs.architectures, 'x64')
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # HARDCODED to x64
        # Cannot use the input array here, otherwise selecting "Both" 
        # would make this job try to run an ARM pass with Intel tools.
        architecture: ['x64'] 
        tcl-version: ${{ fromJSON(github.event.inputs.tcl-versions) }}

    steps:
    - name: Setup BAWT environment
      run: |
       GH_BAWT_BUILDROOT="BawtBuild/${{ matrix.tcl-version }}/${{ github.event.inputs.config }}"
       GH_BAWT_BUILDDIR="$GH_BAWT_BUILDROOT/Linux/${{ matrix.architecture }}"
       echo "GH_BAWT_BUILDROOT=$GH_BAWT_BUILDROOT" >> $GITHUB_ENV
       echo "GH_BAWT_BUILDDIR=$GH_BAWT_BUILDDIR" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl p7zip-full zip \
          libssl-dev ca-certificates \
          libx11-dev libcups2-dev libcairo2-dev libglx-dev \
          libglu1-mesa-dev libasound2-dev libxft-dev libfontconfig1-dev libxrender-dev

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Download BAWT framework
      run: |
        curl -L -o Bawt-3.2.0.zip https://www.bawt.tcl3d.org/download/Framework/Bawt-3.2.0.zip
        unzip Bawt-3.2.0.zip

    - name: Set permissions
      run: |
        cd Bawt-3.2.0
        chmod u+x Build*.sh
        chmod u+x tclkit*

    - name: Build Tcl/Tk Distribution
      run: |
        echo GH_BAWT_BUILDROOT=$GH_BAWT_BUILDROOT
        # Explicitly using Intel kit here
        Bawt-3.2.0/tclkit-Linux64-intel Bawt-3.2.0/Bawt.tcl \
          --rootdir $GH_BAWT_BUILDROOT \
          --architecture ${{ matrix.architecture }} \
          --compiler gcc \
          --numjobs 4 \
          --complete \
          --tclversion ${{ matrix.tcl-version }} \
          --exclude ffmpeg \
          ${{ github.event.inputs.config }}.bawt all

    - name: Upload distribution
      uses: actions/upload-artifact@v4
      with:
        name: tcl-distribution-linux-${{ matrix.tcl-version }}-${{ github.event.inputs.config }}-${{ matrix.architecture }}
        path: ${{ env.GH_BAWT_BUILDDIR }}/Release/Distribution/opt/Tcl

  # -----------------------------------------------------------------------
  # Job 2: ARM64 (Native Runner)
  # -----------------------------------------------------------------------
  build-linux-arm64:
    if: contains(github.event.inputs.architectures, 'arm64')
    # Using the native ARM64 runner for Public repos/Team plans
    runs-on: ubuntu-22.04-arm
    strategy:
      matrix:
        # BAWT uses 'x64' label for 64-bit builds regardless of instruction set
        architecture: ['x64']
        tcl-version: ${{ fromJSON(github.event.inputs.tcl-versions) }}

    steps:
    - name: Setup BAWT environment
      run: |
       GH_BAWT_BUILDROOT="BawtBuild/${{ matrix.tcl-version }}/${{ github.event.inputs.config }}"
       GH_BAWT_BUILDDIR="$GH_BAWT_BUILDROOT/Linux/${{ matrix.architecture }}"
       echo "GH_BAWT_BUILDROOT=$GH_BAWT_BUILDROOT" >> $GITHUB_ENV
       echo "GH_BAWT_BUILDDIR=$GH_BAWT_BUILDDIR" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Keeping smooth font rendering libs: libxft-dev libfontconfig1-dev libxrender-dev
        sudo apt-get install -y build-essential curl p7zip-full zip \
          libssl-dev ca-certificates \
          libx11-dev libcups2-dev libcairo2-dev libglx-dev \
          libglu1-mesa-dev libasound2-dev libxft-dev libfontconfig1-dev libxrender-dev

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Download BAWT framework
      run: |
        curl -L -o Bawt-3.2.0.zip https://www.bawt.tcl3d.org/download/Framework/Bawt-3.2.0.zip
        unzip Bawt-3.2.0.zip

    - name: Set permissions
      run: |
        cd Bawt-3.2.0
        chmod u+x Build*.sh
        chmod u+x tclkit*

    - name: Build Tcl/Tk Distribution
      run: |
        echo GH_BAWT_BUILDROOT=$GH_BAWT_BUILDROOT
        # Explicitly using ARM kit here
        Bawt-3.2.0/tclkit-Linux64-arm Bawt-3.2.0/Bawt.tcl \
          --rootdir $GH_BAWT_BUILDROOT \
          --architecture ${{ matrix.architecture }} \
          --compiler gcc \
          --numjobs 4 \
          --complete \
          --tclversion ${{ matrix.tcl-version }} \
          --exclude ffmpeg \
          ${{ github.event.inputs.config }}.bawt all

    - name: Upload distribution
      uses: actions/upload-artifact@v4
      with:
        name: tcl-distribution-linux-${{ matrix.tcl-version }}-${{ github.event.inputs.config }}-arm64
        path: ${{ env.GH_BAWT_BUILDDIR }}/Release/Distribution/opt/Tcl
